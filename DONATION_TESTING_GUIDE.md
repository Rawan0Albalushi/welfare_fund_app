# 🧪 دليل اختبار نظام التبرع

## نظرة عامة
هذا الدليل يوضح كيفية اختبار نظام التبرع الجديد مع الدفع المباشر (الأسهل).

## 🚀 خطوات الاختبار

### 1. اختبار التطبيق
```bash
# تشغيل التطبيق
flutter run

# أو تشغيل على جهاز محدد
flutter run -d chrome  # للويب
flutter run -d android  # للأندرويد
flutter run -d ios      # للآيفون
```

### 2. اختبار التدفق الكامل

#### الخطوة 1: الوصول لصفحة التبرع
1. افتح التطبيق
2. اذهب إلى "البرامج" أو "الحملات"
3. اختر برنامج أو حملة
4. اضغط على "تبرع الآن"

#### الخطوة 2: اختيار المبلغ
1. اختر مبلغ من المبالغ السريعة (50، 100، 200، 500، 1000 ريال)
2. أو أدخل مبلغ مخصص
3. تأكد من ظهور المبلغ المحدد

#### الخطوة 3: إنشاء التبرع
1. اضغط على زر "تبرع الآن"
2. راقب رسالة التحميل "جاري إنشاء التبرع..."
3. تأكد من عدم إمكانية الضغط على الزر أثناء التحميل

#### الخطوة 4: صفحة الدفع
1. يجب أن تفتح صفحة الدفع (WebView أو المتصفح)
2. تأكد من تحميل صفحة Thawani بشكل صحيح
3. اختبر إدخال بيانات البطاقة التجريبية:
   ```
   رقم البطاقة: 4111111111111111
   تاريخ الانتهاء: 12/25
   CVV: 123
   ```

#### الخطوة 5: إتمام الدفع
1. أكمل عملية الدفع
2. راقب العودة للتطبيق
3. تأكد من ظهور رسالة النجاح

## 🔍 اختبار الحالات المختلفة

### ✅ الحالة الناجحة
- [ ] إنشاء التبرع بنجاح
- [ ] فتح صفحة الدفع
- [ ] إتمام الدفع
- [ ] العودة لصفحة النجاح
- [ ] تحديث حالة التبرع

### ❌ الحالات الفاشلة
- [ ] **خطأ في الشبكة**: قطع الاتصال بالإنترنت
- [ ] **خطأ في الخادم**: إيقاف الخادم
- [ **إلغاء الدفع**: الضغط على زر الإلغاء
- [ ] **انتهاء الجلسة**: عدم إتمام الدفع في الوقت المحدد

### 🔄 اختبار الحالات الحدية
- [ ] **مبلغ صفر**: محاولة التبرع بمبلغ 0
- [ ] **مبلغ كبير**: التبرع بمبلغ 10000 ريال
- [ ] **مبلغ عشري**: التبرع بمبلغ 99.99 ريال
- [ ] **أحرف في المبلغ**: إدخال أحرف بدلاً من أرقام

## 📱 اختبار على منصات مختلفة

### 🌐 الويب
```bash
flutter run -d chrome
```
- [ ] فتح صفحة الدفع في نافذة جديدة
- [ ] العودة للتطبيق بعد الدفع
- [ ] تحديث حالة الدفع

### 📱 الأندرويد
```bash
flutter run -d android
```
- [ ] فتح WebView داخل التطبيق
- [ ] اختبار التنقل بين الصفحات
- [ ] اختبار زر العودة

### 🍎 الآيفون
```bash
flutter run -d ios
```
- [ ] فتح WebView داخل التطبيق
- [ ] اختبار التنقل بين الصفحات
- [ ] اختبار زر العودة

## 🛠️ اختبار API

### اختبار النقاط النهائية

#### 1. إنشاء تبرع مع دفع مباشر
```bash
curl -X POST http://192.168.1.21:8000/api/v1/donations/with-payment \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "campaign_id": "test_campaign_123",
    "amount": 100.00,
    "donor_name": "أحمد محمد",
    "donor_email": "ahmed@test.com",
    "donor_phone": "+96812345678",
    "message": "تبرع تجريبي",
    "is_anonymous": false
  }'
```

#### 2. التحقق من حالة الدفع
```bash
curl -X GET http://192.168.1.21:8000/api/v1/payments/status/SESSION_ID \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 📊 مراقبة السجلات

### سجلات Flutter
```dart
// في console
flutter logs

// أو في التطبيق
print('DonationService: Creating donation...');
```

### سجلات الخادم
```bash
# Laravel logs
tail -f storage/logs/laravel.log

# أو في التطبيق
Log::info('Donation created', ['data' => $donationData]);
```

## 🐛 استكشاف الأخطاء

### مشاكل شائعة

#### 1. خطأ في الاتصال
```
Error: Connection refused
```
**الحل**: تأكد من تشغيل الخادم على `http://192.168.1.21:8000`

#### 2. خطأ في المصادقة
```
Error: 401 Unauthorized
```
**الحل**: تأكد من صحة token المصادقة

#### 3. خطأ في البيانات
```
Error: 422 Validation failed
```
**الحل**: تأكد من صحة البيانات المرسلة

#### 4. خطأ في WebView
```
Error: WebView not available
```
**الحل**: تأكد من تثبيت webview_flutter

## 📈 اختبار الأداء

### قياس الأوقات
```dart
final stopwatch = Stopwatch()..start();

// إنشاء التبرع
final result = await donationService.createDonationWithPayment(...);

stopwatch.stop();
print('Donation creation time: ${stopwatch.elapsedMilliseconds}ms');
```

### الأوقات المستهدفة
- إنشاء التبرع: < 3 ثواني
- فتح صفحة الدفع: < 2 ثانية
- التحقق من الحالة: < 1 ثانية

## 🔒 اختبار الأمان

### اختبار البيانات الحساسة
- [ ] عدم طباعة بيانات البطاقة في السجلات
- [ ] استخدام HTTPS للاتصالات
- [ ] التحقق من صحة البيانات المدخلة

### اختبار المصادقة
- [ ] رفض الطلبات بدون token
- [ ] رفض الطلبات بtoken منتهي الصلاحية
- [ ] التحقق من صلاحيات المستخدم

## 📝 تقرير الاختبار

### نموذج التقرير
```markdown
## تقرير اختبار التبرع
**التاريخ**: [التاريخ]
**الإصدار**: [رقم الإصدار]
**المنصة**: [الويب/الأندرويد/الآيفون]

### النتائج
- ✅ إنشاء التبرع: [نجح/فشل]
- ✅ فتح صفحة الدفع: [نجح/فشل]
- ✅ إتمام الدفع: [نجح/فشل]
- ✅ العودة للتطبيق: [نجح/فشل]

### المشاكل المكتشفة
1. [وصف المشكلة]
2. [وصف المشكلة]

### التوصيات
1. [التوصية]
2. [التوصية]
```

## 🎯 اختبار سيناريوهات محددة

### سيناريو 1: تبرع ناجح
1. المستخدم يختار مبلغ 100 ريال
2. يضغط على "تبرع الآن"
3. يفتح صفحة الدفع
4. يدخل بيانات البطاقة
5. يضغط على "إتمام الدفع"
6. يعود للتطبيق
7. يظهر رسالة النجاح

### سيناريو 2: إلغاء الدفع
1. المستخدم يختار مبلغ 50 ريال
2. يضغط على "تبرع الآن"
3. يفتح صفحة الدفع
4. يضغط على "إلغاء"
5. يعود للتطبيق
6. يظهر رسالة الإلغاء

### سيناريو 3: خطأ في الشبكة
1. المستخدم يختار مبلغ 200 ريال
2. يقطع الاتصال بالإنترنت
3. يضغط على "تبرع الآن"
4. يظهر رسالة خطأ الشبكة

## 🚀 تشغيل الاختبارات التلقائية

### اختبار الوحدة
```bash
flutter test test/donation_test.dart
```

### اختبار التكامل
```bash
flutter test test/integration/donation_flow_test.dart
```

## 📞 الدعم

إذا واجهت أي مشاكل أثناء الاختبار:
1. راجع سجلات التطبيق
2. راجع سجلات الخادم
3. تأكد من صحة البيانات
4. اتصل بفريق التطوير
